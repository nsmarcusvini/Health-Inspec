<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Inspec | Dashboard</title>
    <link rel="stylesheet" href="./css/dashboard-maquinas.css">
    <script src="./assets/js/funcoes.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body onload="validarSessao()">
    <div class="sidebar-menu-container">
        <div class="sidebar-menu">
            <div class="user-container">
                <div class="user-icon"></div>

                <span class="username" id="employeeName"></span>
            </div>

            <div class="items-container">
                <ul>
                    <!-- <li>
                        <a href="cadastro-maquinas.html">Cadastrar máquinas</a>
                    </li> -->
                    
                    <li>
                        <a href="tabela-maquinas.html">Máquinas cadastradas</a>
                    </li>
                    
                    <li>
                        <a href="dashboard-maquinas.html" class="current">Dashboards</a>
                    </li>
                    
                    <li>
                        <a href="index.html">Sair</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="page-content">
        <!-- <div class="open-slide">
            <a href="#" id="sidebar-open-button">
                <svg width="30" height="30">
                    <path d="M0, 5 30,5" stroke="black" stroke-width="5"/>
                    <path d="M0, 14 30,14" stroke="black" stroke-width="5"/>
                    <path d="M0, 23 30,23" stroke="black" stroke-width="5"/>
                </svg>
            </a>
        </div> -->

        <div class="page-title">
            <div class="title">
                Monitoramento de componentes
            </div>

            <div class="select-machine-container">
                <label for="select-machine">Máquina selecionada: </label>
                <select name="select-machine" id="select_machine">
                    <option value=""></option>
                    <option value="">Máquina teste</option>
                </select>
            </div>
        </div>


        <div class="cards-container">
            <div id="card1" class="card" onclick="obterDadosGrafico(ram)">
                <div class="card-title">RAM</div>
                <div class="card-subtitle">Espaço total - 8GB</div>
                <div class="card-subtitle">Espaço livre - 30%</div>
                <div class="card-status">
                    <div class="box green"></div>
                    <label>Ideal</label>
                </div>
            </div>
            
            <div id="card2" class="card" onclick="obterDadosGrafico(disco)">
                <div class="card-title">Disco</div>
                <div class="card-subtitle">Espaço total - 256SSD</div>
                <div class="card-subtitle">Espaço livre - 20%</div>
                <div class="card-status">
                    <div class="box yellow"></div>
                    Alerta!
                </div>
            </div>

            <div id="card3" class="card" onclick="obterDadosGrafico(processador)">
                <div class="card-title">Processador</div>
                <div class="card-subtitle">Uso ideal - 65%</div>
                <div class="card-subtitle">Uso atual - 90%</div>
                <div class="card-status">
                    <div class="box red"></div>
                    Urgente!
                </div>
            </div>
        </div>

        <div class="graph-container">
            <div class="graph-title-container">
                <div class="graph-title">Gráfico - RAM</div>

                <div class="graph-desc">
                    <div class="box-container">
                        <div class="box green"></div> 
                        <label class="desc">Uso ideal</label>
                        <label>-</label>
                        <label id="graph-range" class="range">até 600</label>
                    </div>
                    
                    <div class="box-container">
                        <div class="box yellow"></div> 
                        <label class="desc">Uso em alerta</label>
                        <label>-</label>
                        <label id="graph-range" class="range">600 a 700</label>
                    </div>
                    
                    <div class="box-container">
                        <div class="box red"></div> 
                        <label class="desc">Uso em urgência</label>
                        <label>-</label>
                        <label id="graph-range" class="range">acima de 700</label>
                    </div>
                </div>
            </div>

            <div class="graph">
                <canvas id="chart_ram" style="display: none;"></canvas>
                <canvas id="chart_disco" style="display: none;"></canvas>
                <canvas id="chart_cpu" style="display: none;"></canvas>
            </div>
        </div>
    </div>
</body>
</html>

<script src='./node_modules/chart.js/dist/Chart.js'></script>
<script src="./js/dashboard.js"></script>  

<script>
    const card1 = document.getElementById("card1");
    const card2 = document.getElementById("card2");
    const card3 = document.getElementById("card3");

    card1.addEventListener("click", () => {
        card1.classList.toggle("active");
        card2.classList.remove("active");
        card3.classList.remove("active");

        if (card1.classList.contains("active")) {
            document.getElementById("chart_ram").style.display = "block";
        } else {
            document.getElementById("chart_ram").style.display = "none";
        }

        document.getElementById("chart_disco").style.display = "none";
        document.getElementById("chart_cpu").style.display = "none";
    });

    card2.addEventListener("click", () => {
        card2.classList.toggle("active");
        card1.classList.remove("active");
        card3.classList.remove("active");

        if (card2.classList.contains("active")) {
            document.getElementById("chart_disco").style.display = "block";
        } else {
            document.getElementById("chart_disco").style.display = "none";
        }

        document.getElementById("chart_ram").style.display = "none";
        document.getElementById("chart_cpu").style.display = "none";
    });
    
    card3.addEventListener("click", () => {
        card3.classList.toggle("active");
        card1.classList.remove("active");
        card2.classList.remove("active");
        
        if (card3.classList.contains("active")) {
            document.getElementById("chart_cpu").style.display = "block";
        } else {
            document.getElementById("chart_cpu").style.display = "none";
        }
        
        document.getElementById("chart_ram").style.display = "none";
        document.getElementById("chart_disco").style.display = "none";
    });
</script>

<script>
    let proximaAtualizacao;
    let proximaAtualizacao2;
    
    function obterDadosGrafico(idComponente) {
        if (proximaAtualizacao != undefined && proximaAtualizacao2 != undefined) {
            clearTimeout(proximaAtualizacao);
            clearTimeout(proximaAtualizacao2);
        }

        fetch(`/medidas/ultimas/${idComponente}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idComponente);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        }).catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
    }

    function plotarGrafico(resposta, idComponente) {
        console.log('iniciando plotagem do gráfico...');

        var dados = {
            labels: [],
            datasets: [
                {
                    // label: 'Luminosidade',
                    // borderColor: '#32B9CD',
                    // backgroundColor: '#32b9cd8f',
                    fill: true,
                    data: []
                }
            ]
        };

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.logLuminosidade * Math.random());
        }

        console.log(JSON.stringify(dados));

        var ctx = canvas_grafico.getContext('2d');
        window.grafico_linha = Chart.Line(ctx, {
            data: dados,
            //Configurações do gráfico
            options: {
                responsive: true,
                animation: { duration: 500 },
                hoverMode: 'index',
                stacked: false,
                title: {
                    display: true,
                    text: 'Histórico recente de Luminosidade'
                },
                scales: {
                    yAxes: [ {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        id: 'y-luminosidade',

                        gridLines: {
                            drawOnChartArea: false,
                        },
                    }],
                }
            }
        });

        
        //Atualiza os dados de 2 em 2 segundos
        setTimeout(() => atualizarGrafico(idComponente, dados), 3000);
    }

    function atualizarGrafico(idSensor, dados) {
        fetch(`/medidas/tempo-real/${idSensor}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico: ${dados.labels}`);
                    console.log(`Dados atuais do gráfico: ${dados.datasets[0].data}`);

                    // tirando e colocando valores no gráfico
                    dados.labels.shift(); // apagar o primeiro
                    dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento
                    dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                    dados.datasets[0].data.push(novoRegistro[0].logLuminosidade); // incluir uma nova medida de umidade

                    if(novoRegistro[0].logLuminosidade < 300) {
                        dados.datasets[0].borderColor = "#cd32328f";
                        dados.datasets[0].backgroundColor = "#cd32328f";
                        div_msg.innerHTML = `<h2 style="color: #cd32328f;">Luminosidade ${novoRegistro[0].logLuminosidade}, muito abaixo dos padrões ideais, estado crítico!!!</h2><br>
                            <h4 style="color: #fff;">Resolva URGENTEMETE o controle de Luminosidade da sua Estufa!</h4>
                            `
                    } else if (novoRegistro[0].logLuminosidade < 400) {
                        dados.datasets[0].borderColor = "#eb720f8f";
                        dados.datasets[0].backgroundColor = "#eb720f8f";
                        div_msg.innerHTML = `<h2 style="color: #eb720f8f;">Luminosidade ${novoRegistro[0].logLuminosidade}, abaixo dos padrões ideais, estado emergêncial</h2><br>
                        <h4 style="color: #fff;"> Resolva o controle de Luminosidade da sua Estufa o mais cedo possível</h4>`
                    } else if (novoRegistro[0].logLuminosidade < 500) {
                        dados.datasets[0].borderColor = "#dfca158f";
                        dados.datasets[0].backgroundColor = "#dfca158f";
                        div_msg.innerHTML = `<h2 style="color: #dfca158f;">Luminosidade ${novoRegistro[0].logLuminosidade}, abaixo do padrão ideal </h2><br>
                        <h4 style="color: #fff;"> Cheque o controle de Luminosidade da sua Estufa</h4>`
                    } else if (novoRegistro[0].logLuminosidade < 900) {
                        dados.datasets[0].borderColor = "#6bcd328f";
                        dados.datasets[0].backgroundColor = "#6bcd328f";
                        div_msg.innerHTML = `<h2 style="color: #6bcd328f;">Luminosidade ${novoRegistro[0].logLuminosidade},  nos padrões ideais</h2> <br>
                        <h4 style="color: #fff;"> Nada a se fazer</h4>`
                    } else if (novoRegistro[0].logLuminosidade < 1000) {
                        dados.datasets[0].borderColor = "#dfca158f";
                        dados.datasets[0].backgroundColor = "#dfca158f";
                        div_msg.innerHTML = `<h2 style="color: #dfca158f;">Luminosidade ${novoRegistro[0].logLuminosidade}, acima dos padrões ideais </h2><br>
                        <h4 style="color: #fff;">  Cheque o controle de Luminosidade da sua Estufa</h4>`
                    } else if (novoRegistro[0].logLuminosidade <= 1100) {
                        dados.datasets[0].borderColor = "#eb720f8f";
                        dados.datasets[0].backgroundColor = "#eb720f8f";
                        div_msg2.innerHTML = `<h2 style="color: #eb720f8f;">Luminosidade ${novoRegistro[0].logLuminosidade}, acima dos padrões ideais, estado emergêncial</h2><br>
                        <h4 style="color: #fff;">Resolva o controle de Luminosidade da sua Estufa o mais cedo possível</h4>`
                    } else if (novoRegistro[0].logLuminosidade > 1100) {
                        dados.datasets[0].borderColor = "#cd32328f";
                        dados.datasets[0].backgroundColor = "#cd32328f";
                        div_msg.innerHTML = `<h2 style="color: #cd32328f;">Luminosidade ${novoRegistro[0].logLuminosidade}, muito acima dos padrões ideais, estado crítico!!!</h2><br>
                        <h4 style="color: #fff;"> Resolva URGENTEMETE o controle de Luminosidade da sua Estufa!</h4>`
                    }

                    window.grafico_linha.update();

                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados), 5000);

                });

                if(novoRegistro[0].logLuminosidade < 650) {
                    canvas_grafico.dados.datasets[0].backgroundColor = "red"
                }

            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados), 5000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
</script>