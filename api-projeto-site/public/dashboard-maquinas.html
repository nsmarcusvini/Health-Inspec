<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Inspec | Dashboard</title>
    <link rel="stylesheet" href="./css/dashboard-maquinas.css">
    <script src="./assets/js/funcoes.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body onload="validarSessao()">
    <!--StartofhealthinspecsupportZendeskWidgetscript-->
    <script id="ze-snippet" src="https://static.zdassets.com/ekr/snippet.js?key=d84d7d73-a41a-42c7-8837-da33a68c5c2a"></script>
    <!--EndofhealthinspecsupportZendeskWidgetscript-->
    <div class="sidebar-menu-container">
        <div class="sidebar-menu">
            <div class="user-container">
                <div class="user-icon"></div>

                <span class="username" id="employeeName"></span>
            </div>

            <div class="items-container">
                <ul>
                    <!-- <li>
                        <a href="cadastro-maquinas.html">Cadastrar máquinas</a>
                    </li> -->
                    
                    <li>
                        <a href="tabela-maquinas.html">Máquinas cadastradas</a>
                    </li>
                    
                    <li>
                        <a href="dashboard-maquinas.html" class="current">Dashboards</a>
                    </li>
                    
                    <li>
                        <a href="index.html">Sair</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="page-content">
        <!-- <div class="open-slide">
            <a href="#" id="sidebar-open-button">
                <svg width="30" height="30">
                    <path d="M0, 5 30,5" stroke="black" stroke-width="5"/>
                    <path d="M0, 14 30,14" stroke="black" stroke-width="5"/>
                    <path d="M0, 23 30,23" stroke="black" stroke-width="5"/>
                </svg>
            </a>
        </div> -->

        <div class="page-title">
            <div class="title">
                Monitoramento de componentes
            </div>

            <div class="select-machine-container">
                <label for="select-machine">Máquina selecionada: </label>
                <select name="select-machine" id="select_machine" onchange="selecionarMaquina()">
                    <option value=""></option>
                </select>
            </div>
        </div>

        <div class="cards-container">
            <div id="card1" class="card" onclick="obterDadosGrafico(1)">
                <div class="card-title">RAM</div>
                <div class="card-subtitle">Espaço total - <span id="totalRam"></span>GB</div>
                <div class="card-subtitle">Espaço usado - <span id="usadoRam"></span>%</div>
                <div id="status_ram" class="card-status">
                    <!-- <div class="box green"></div>
                    <label>Ideal</label> -->
                </div>
            </div>
            
            <div id="card2" class="card" onclick="obterDadosGrafico(2)">
                <div class="card-title">Disco</div>
                <div class="card-subtitle">Espaço total - <span id="totalDisco"></span>GB</div>
                <div class="card-subtitle">Espaço usado - <span id="usadoDisco"></span>%</div>
                <div id="status_disco" class="card-status">
                    <!-- <div class="box yellow"></div>
                    Alerta! -->
                </div>
            </div>

            <div id="card3" class="card" onclick="obterDadosGrafico(3)">
                <div class="card-title">Processador</div>
                <div class="card-subtitle">Total - <span id="totalProcessador"></span>GHz</div>
                <div class="card-subtitle">Uso atual - <span id="usadoProcessador"></span>%</div>
                <div id="status_processador" class="card-status">
                    <!-- <div id="status_processador" class="box red"></div>
                    Urgente! -->
                </div>
            </div>
        </div>

        <div class="graph-container">
            <div class="graph-title-container">
                <div class="graph-title">Gráfico - RAM</div>

                <div class="graph-desc">
                    <div class="box-container">
                        <div class="box green"></div> 
                        <label class="desc">Uso ideal</label>
                        <label>-</label>
                        <label id="graph-range" class="range">até 600</label>
                    </div>
                    
                    <div class="box-container">
                        <div class="box yellow"></div> 
                        <label class="desc">Uso em alerta</label>
                        <label>-</label>
                        <label id="graph-range" class="range">600 a 700</label>
                    </div>
                    
                    <div class="box-container">
                        <div class="box red"></div> 
                        <label class="desc">Uso em urgência</label>
                        <label>-</label>
                        <label id="graph-range" class="range">acima de 700</label>
                    </div>
                </div>
            </div>

            <div class="graph">
                <canvas id="chart_ram" style="display: none;"></canvas>
                <canvas id="chart_disco" style="display: none;"></canvas>
                <canvas id="chart_cpu" style="display: none;"></canvas>
            </div>
        </div>
    </div>
</body>
</html>

<script src='./node_modules/chart.js/dist/Chart.js'></script>
<script src="./js/dashboard.js"></script>  

<script>
    const card1 = document.getElementById("card1");
    const card2 = document.getElementById("card2");
    const card3 = document.getElementById("card3");

    card1.addEventListener("click", () => {
        card1.classList.toggle("active");
        card2.classList.remove("active");
        card3.classList.remove("active");

        if (card1.classList.contains("active")) {
            document.getElementById("chart_ram").style.display = "block";
        } else {
            document.getElementById("chart_ram").style.display = "none";
        }

        document.getElementById("chart_disco").style.display = "none";
        document.getElementById("chart_cpu").style.display = "none";
    });

    card2.addEventListener("click", () => {
        card2.classList.toggle("active");
        card1.classList.remove("active");
        card3.classList.remove("active");

        if (card2.classList.contains("active")) {
            document.getElementById("chart_disco").style.display = "block";
        } else {
            document.getElementById("chart_disco").style.display = "none";
        }

        document.getElementById("chart_ram").style.display = "none";
        document.getElementById("chart_cpu").style.display = "none";
    });
    
    card3.addEventListener("click", () => {
        card3.classList.toggle("active");
        card1.classList.remove("active");
        card2.classList.remove("active");
        
        if (card3.classList.contains("active")) {
            document.getElementById("chart_cpu").style.display = "block";
        } else {
            document.getElementById("chart_cpu").style.display = "none";
        }
        
        document.getElementById("chart_ram").style.display = "none";
        document.getElementById("chart_disco").style.display = "none";
    });
</script>

<script>
    fetch(`/usuarios/listarMaquinas/${sessionStorage.FK_HOSPITAL}`).then(function(resposta) {
        if (resposta.ok) {
            resposta.json().then(function(resposta) {
                let machineSelect = document.getElementById("select_machine");

                for (let i = 0; i < resposta.length; i++) {
                    let maquina = resposta[i];

                    let nameOption = document.createElement("option");
                    nameOption.value = maquina.idMaquina;
                    nameOption.textContent = maquina.apelido == null ? maquina.nomeMaquina : maquina.apelido;

                    machineSelect.appendChild(nameOption);
                }
            })
        } else {
            throw(`Houve um erro! ${resposta.status} - ${resposta}`);
        }
    }).catch(function(resposta) {
        console.log(resposta);
    })
</script>

<script>
    function selecionarMaquina() {
        const selectedMachine = document.getElementById("select_machine").value;

        if (selectedMachine == "") {
            document.getElementById("totalRam").textContent = "";
            document.getElementById("usadoRam").textContent = "";
            document.getElementById("totalDisco").textContent = "";
            document.getElementById("usadoDisco").textContent = "";
            document.getElementById("totalProcessador").textContent = "";
            document.getElementById("usadoProcessador").textContent = "";
            document.getElementById("status_ram").innerHTML = "";

            return false;
        }

        fetchTotalRam(selectedMachine);
        fetchUsadoRam(selectedMachine);

        fetchTotalDisco(selectedMachine);
        fetchUsadoDisco(selectedMachine);
        
        fetchTotalProcessador(selectedMachine);
        fetchUsadoProcessador(selectedMachine);

        const statusRam = document.getElementById("status_ram");
        const statusDisco = document.getElementById("status_disco");
        const statusProcessador = document.getElementById("status_processador");

        exibirEstadoComponente(sessionStorage.PORCENTAGEM_RAM, statusRam);
        exibirEstadoComponente(sessionStorage.PORCENTAGEM_DISCO, statusDisco);
        exibirEstadoComponente(sessionStorage.PORCENTAGEM_PROCESSADOR, statusProcessador);
    }

    function fetchTotalRam(idMaquina) {
        fetch(`/usuarios/getTotalRam/${idMaquina}`).then(function(resposta) {
            if (resposta.ok) {
                resposta.json().then(function(resposta) {
                    let totalRam = document.getElementById("totalRam");

                    for (let i = 0; i < resposta.length; i++) {
                        let componente = resposta[i];

                        totalRam.textContent = componente.totalComponente;
                        sessionStorage.TOTAL_RAM = componente.totalComponente;
                    }
                })
            } else {
                throw(`Houve um erro! ${resposta.status} - ${resposta}`);
            }
        }).catch(function(resposta) {
            console.log(resposta);
        })
    }

    function fetchTotalDisco(idMaquina) {
        fetch(`/usuarios/getTotalDisco/${idMaquina}`).then(function(resposta) {
            if (resposta.ok) {
                resposta.json().then(function(resposta) {
                    let totalDisco = document.getElementById("totalDisco");

                    for (let i = 0; i < resposta.length; i++) {
                        let componente = resposta[i];

                        totalDisco.textContent = componente.totalComponente;
                        sessionStorage.TOTAL_DISCO = componente.totalComponente;
                    }
                })
            } else {
                throw(`Houve um erro! ${resposta.status} - ${resposta}`);
            }
        }).catch(function(resposta) {
            console.log(resposta);
        })
    }

    function fetchTotalProcessador(idMaquina) {
        fetch(`/usuarios/getTotalProcessador/${idMaquina}`).then(function(resposta) {
            if (resposta.ok) {
                resposta.json().then(function(resposta) {
                    let totalProcessador = document.getElementById("totalProcessador");

                    for (let i = 0; i < resposta.length; i++) {
                        let componente = resposta[i];

                        totalProcessador.textContent = componente.totalComponente;
                    }
                })
            } else {
                throw(`Houve um erro! ${resposta.status} - ${resposta}`);
            }
        }).catch(function(resposta) {
            console.log(resposta);
        })
    }

    function fetchUsadoRam(idMaquina) {
        fetch(`/usuarios/getUsadoRam/${idMaquina}`).then(function(resposta) {
            if (resposta.ok) {
                resposta.json().then(function(resposta) {
                    let usadoRam = document.getElementById("usadoRam");

                    for (let i = 0; i < resposta.length; i++) {
                        let componente = resposta[i];

                        usadoRam.textContent = ((componente.totalUsado * 100) / parseInt(sessionStorage.TOTAL_RAM)).toFixed(2);

                        sessionStorage.PORCENTAGEM_RAM = ((componente.totalUsado * 100) / parseInt(sessionStorage.TOTAL_RAM)).toFixed(2);
                    }
                })
            } else {
                throw(`Houve um erro! ${resposta.status} - ${resposta}`);
            }
        }).catch(function(resposta) {
            console.log(resposta);
        })
    }

    function fetchUsadoDisco(idMaquina) {
        fetch(`/usuarios/getUsadoDisco/${idMaquina}`).then(function(resposta) {
            if (resposta.ok) {
                resposta.json().then(function(resposta) {
                    let usadoDisco = document.getElementById("usadoDisco");

                    for (let i = 0; i < resposta.length; i++) {
                        let componente = resposta[i];

                        usadoDisco.textContent = (
                            100.00 - ( (componente.totalUsado * 100) / parseInt(sessionStorage.TOTAL_DISCO) )
                        ).toFixed(2);

                        sessionStorage.PORCENTAGEM_DISCO = (
                            100.00 - ( (componente.totalUsado * 100) / parseInt(sessionStorage.TOTAL_DISCO) )
                        ).toFixed(2);
                    }
                })
            } else {
                throw(`Houve um erro! ${resposta.status} - ${resposta}`);
            }
        }).catch(function(resposta) {
            console.log(resposta);
        })
    }

    function fetchUsadoProcessador(idMaquina) {
        fetch(`/usuarios/getUsadoProcessador/${idMaquina}`).then(function(resposta) {
            if (resposta.ok) {
                resposta.json().then(function(resposta) {
                    let usadoProcessador = document.getElementById("usadoProcessador");

                    for (let i = 0; i < resposta.length; i++) {
                        let componente = resposta[i];

                        usadoProcessador.textContent = componente.totalUsado;
                        sessionStorage.PORCENTAGEM_PROCESSADOR = componente.totalUsado;
                    }
                })
            } else {
                throw(`Houve um erro! ${resposta.status} - ${resposta}`);
            }
        }).catch(function(resposta) {
            console.log(resposta);
        })
    }

    function exibirEstadoComponente(porcentagem, container) {
        const box = document.createElement("div");
        box.classList.add("box");

        const label = document.createElement("label");

        if (porcentagem < 40) {
            box.classList.add("green");    
            label.textContent = "Ideal!";
        } else if (porcentagem < 70) {
            box.classList.add("yellow");
            label.textContent = "Alerta!";
        } else {
            box.classList.add("red");
            label.textContent = "Urgente!";
        }

        container.appendChild(box);
        container.appendChild(label);
    }
</script>
